include:
 - https://gitlab.gnome.org/Infrastructure/freedesktop-ci-templates/-/raw/master/templates/fedora.yml

variables:
  COMMON_BUILD_OPTIONS: --prefix=/usr --sysconfdir=/etc --localstatedir=/var --mandir=/usr/share/man --libdir=/usr/lib64 -Dpam-prefix=/etc -Drun-dir=/run/gdm -Dudev-dir=/lib/udev/rules.d -Ddefault-path=/usr/local/bin:/usr/local/sbin:/usr/bin:/usr/sbin -Dprofiling=true -Dplymouth=enabled -Dselinux=enabled

stages:
  - prepare
  - build

.gdm.fedora:
  variables:
    FDO_DISTRIBUTION_VERSION: 41
    FDO_DISTRIBUTION_TAG: '2025-02-06.0'
    FDO_DISTRIBUTION_PACKAGES:
      accountsservice-devel
      audit-libs-devel
      check-devel
      dconf
      desktop-file-utils
      gettext-devel
      git
      gobject-introspection-devel
      iso-codes-devel
      itstool
      json-glib-devel
      keyutils-libs-devel
      libattr-devel
      libgudev-devel
      libdmx-devel
      libselinux-devel
      libtool
      meson
      nss-devel
      pam-devel
      plymouth-devel
      redhat-rpm-config
      systemd
      systemd-devel
      which
      yelp-devel
      gtk3-devel
      libXau-devel
      libXdmcp-devel
      xorg-x11-server-Xorg
      xorg-x11-server-devel

build-fedora-container:
  extends:
    - .fdo.container-build@fedora@x86_64
    - .gdm.fedora
  stage: prepare

build-fedora:
  extends:
    - .fdo.distribution-image@fedora
    - .gdm.fedora
  stage: build
  script:
    - meson setup build ${COMMON_BUILD_OPTIONS}
    - meson compile -C build
    - meson install -C build
    - meson dist -C build
    - meson test -C build
  except:
    - tags

build-fedora-wayland:
  extends:
    - .fdo.distribution-image@fedora
    - .gdm.fedora
  stage: build
  script:
    - meson setup build ${COMMON_BUILD_OPTIONS} -Dx11-support=false
    - meson compile -C build
    - meson install -C build
    - meson dist -C build
    - meson test -C build
  except:
    - tags
